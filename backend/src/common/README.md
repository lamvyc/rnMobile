# é€šç”¨æ¨¡å—æ–‡æ¡£

æœ¬ç›®å½•åŒ…å«é¡¹ç›®çš„é€šç”¨åŠŸèƒ½ç»„ä»¶ï¼ŒåŒ…æ‹¬å¼‚å¸¸è¿‡æ»¤å™¨ã€å“åº”æ‹¦æˆªå™¨å’Œé€šç”¨ DTOã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
common/
â”œâ”€â”€ dto/                    # é€šç”¨æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â””â”€â”€ response.dto.ts     # ç»Ÿä¸€å“åº”æ ¼å¼å®šä¹‰
â”œâ”€â”€ filters/                # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”œâ”€â”€ all-exceptions.filter.ts      # æ•è·æ‰€æœ‰å¼‚å¸¸
â”‚   â””â”€â”€ http-exception.filter.ts      # å¤„ç†HTTPå¼‚å¸¸
â”œâ”€â”€ interceptors/           # æ‹¦æˆªå™¨
â”‚   â””â”€â”€ transform.interceptor.ts      # ç»Ÿä¸€å“åº”æ ¼å¼è½¬æ¢
â””â”€â”€ index.ts                # å¯¼å‡ºæ–‡ä»¶

```

---

## ğŸ¯ ç»Ÿä¸€ API å“åº”æ ¼å¼

### æˆåŠŸå“åº”æ ¼å¼

æ‰€æœ‰æˆåŠŸçš„ API å“åº”éƒ½ä¼šè¢«è‡ªåŠ¨åŒ…è£…ä¸ºä»¥ä¸‹æ ¼å¼ï¼š

```json
{
  "code": 200,
  "data": {
    // å®é™…è¿”å›çš„æ•°æ®
  },
  "message": "æ“ä½œæˆåŠŸ",
  "timestamp": "2024-01-27 18:15:00",
  "path": "/api/contacts"
}
```

### é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰é”™è¯¯å“åº”ä¹Ÿä¼šè¢«ç»Ÿä¸€æ ¼å¼åŒ–ï¼š

```json
{
  "code": 400,
  "data": null,
  "message": "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®",
  "timestamp": "2024-01-27 18:15:00",
  "path": "/api/auth/login"
}
```

---

## ğŸ”§ ç»„ä»¶è¯´æ˜

### 1. AllExceptionsFilterï¼ˆå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼‰

æ•è·æ‰€æœ‰ç±»å‹çš„å¼‚å¸¸ï¼ŒåŒ…æ‹¬ï¼š
- HTTP å¼‚å¸¸ï¼ˆBadRequestException, UnauthorizedException ç­‰ï¼‰
- æœªé¢„æœŸçš„è¿è¡Œæ—¶é”™è¯¯
- æ•°æ®åº“é”™è¯¯
- ç¬¬ä¸‰æ–¹æœåŠ¡é”™è¯¯

**ç‰¹æ€§ï¼š**
- è‡ªåŠ¨æå–é”™è¯¯æ¶ˆæ¯
- è®°å½•é”™è¯¯æ—¥å¿—ï¼ˆ500+ é”™è¯¯ä¼šè®°å½•è¯¦ç»†å †æ ˆï¼‰
- è¿”å›ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯å“åº”

### 2. HttpExceptionFilterï¼ˆHTTPå¼‚å¸¸è¿‡æ»¤å™¨ï¼‰

ä¸“é—¨å¤„ç† NestJS çš„ HttpException åŠå…¶å­ç±»ã€‚

**æ”¯æŒçš„å¼‚å¸¸ç±»å‹ï¼š**
- BadRequestException (400)
- UnauthorizedException (401)
- ForbiddenException (403)
- NotFoundException (404)
- InternalServerErrorException (500)
- ç­‰ç­‰...

### 3. TransformInterceptorï¼ˆå“åº”è½¬æ¢æ‹¦æˆªå™¨ï¼‰

è‡ªåŠ¨å°†æ‰€æœ‰æˆåŠŸçš„å“åº”åŒ…è£…ä¸ºç»Ÿä¸€æ ¼å¼ã€‚

**ç‰¹æ€§ï¼š**
- è‡ªåŠ¨æå– `message` å­—æ®µ
- ä¿ç•™åŸå§‹æ•°æ®ç»“æ„
- æ·»åŠ æ—¶é—´æˆ³å’Œè¯·æ±‚è·¯å¾„
- æ™ºèƒ½åˆ¤æ–­æ˜¯å¦å·²ç»æ˜¯æ ‡å‡†æ ¼å¼ï¼ˆé¿å…é‡å¤åŒ…è£…ï¼‰

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### Controller ä¸­çš„ä½¿ç”¨

**ä¹‹å‰çš„å†™æ³•ï¼š**
```typescript
@Get()
async findAll() {
  const users = await this.usersService.findAll();
  return {
    message: 'è·å–æˆåŠŸ',
    users: users,
    total: users.length,
  };
}
```

**ç°åœ¨çš„å†™æ³•ï¼ˆæ›´ç®€æ´ï¼‰ï¼š**
```typescript
@Get()
async findAll() {
  const users = await this.usersService.findAll();
  return {
    message: 'è·å–æˆåŠŸ',  // ä¼šè¢«æå–åˆ°å¤–å±‚
    users: users,
    total: users.length,
  };
}
```

**å®é™…è¿”å›ç»™å‰ç«¯ï¼š**
```json
{
  "code": 200,
  "data": {
    "users": [...],
    "total": 10
  },
  "message": "è·å–æˆåŠŸ",
  "timestamp": "2024-01-27 18:15:00",
  "path": "/api/users"
}
```

### å¼‚å¸¸å¤„ç†ç¤ºä¾‹

**Service ä¸­æŠ›å‡ºå¼‚å¸¸ï¼š**
```typescript
async findOne(id: string) {
  const user = await this.userRepository.findOne({ where: { id } });
  if (!user) {
    throw new NotFoundException('ç”¨æˆ·ä¸å­˜åœ¨');
  }
  return user;
}
```

**è‡ªåŠ¨è¿”å›ç»™å‰ç«¯ï¼š**
```json
{
  "code": 404,
  "data": null,
  "message": "ç”¨æˆ·ä¸å­˜åœ¨",
  "timestamp": "2024-01-27 18:15:00",
  "path": "/api/users/123"
}
```

---

## âœ… éªŒè¯é”™è¯¯å¤„ç†

DTO éªŒè¯å¤±è´¥æ—¶ä¹Ÿä¼šè‡ªåŠ¨æ ¼å¼åŒ–ï¼š

**DTO å®šä¹‰ï¼š**
```typescript
export class CreateUserDto {
  @IsString()
  @Length(11, 11, { message: 'æ‰‹æœºå·å¿…é¡»ä¸º11ä½' })
  phone: string;
}
```

**éªŒè¯å¤±è´¥è¿”å›ï¼š**
```json
{
  "code": 400,
  "data": null,
  "message": "æ‰‹æœºå·å¿…é¡»ä¸º11ä½",
  "timestamp": "2024-01-27 18:15:00",
  "path": "/api/users"
}
```

---

## ğŸš€ ä¼˜åŠ¿

1. **å‰ç«¯ç»Ÿä¸€å¤„ç†**ï¼šå‰ç«¯åªéœ€æ£€æŸ¥ `code` å­—æ®µå³å¯åˆ¤æ–­æˆåŠŸ/å¤±è´¥
2. **è‡ªåŠ¨åŒ–**ï¼šå¼€å‘è€…æ— éœ€æ‰‹åŠ¨åŒ…è£…æ¯ä¸ªå“åº”
3. **å¯è¿½è¸ª**ï¼šåŒ…å«æ—¶é—´æˆ³å’Œè¯·æ±‚è·¯å¾„ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
4. **æ—¥å¿—å®Œæ•´**ï¼šè‡ªåŠ¨è®°å½•é”™è¯¯æ—¥å¿—ï¼Œ500+ é”™è¯¯ä¼šè®°å½•å †æ ˆ
5. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript æ³›å‹ä¿è¯ç±»å‹å®‰å…¨

---

## ğŸ“Š çŠ¶æ€ç è§„èŒƒ

| Code | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| 200 | æˆåŠŸ | æ•°æ®æŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | DTO éªŒè¯å¤±è´¥ |
| 401 | æœªæˆæƒ | Token æ— æ•ˆæˆ–è¿‡æœŸ |
| 403 | ç¦æ­¢è®¿é—® | æƒé™ä¸è¶³ |
| 404 | èµ„æºä¸å­˜åœ¨ | æŸ¥è¯¢çš„æ•°æ®ä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æœªé¢„æœŸçš„è¿è¡Œæ—¶é”™è¯¯ |

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ—¥å¿—

æ‰€æœ‰å¼‚å¸¸éƒ½ä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸­ï¼š

- **400-499 é”™è¯¯**ï¼šWARN çº§åˆ«ï¼Œè®°å½•ç®€è¦ä¿¡æ¯
- **500+ é”™è¯¯**ï¼šERROR çº§åˆ«ï¼Œè®°å½•å®Œæ•´å †æ ˆ

### ä¸´æ—¶ç¦ç”¨æ‹¦æˆªå™¨ï¼ˆè°ƒè¯•ç”¨ï¼‰

å¦‚æœéœ€è¦æŸ¥çœ‹åŸå§‹å“åº”ï¼ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰ï¼š

```typescript
// åœ¨ç‰¹å®šæ¥å£ä¸Šç¦ç”¨
@UseInterceptors() // æ¸…ç©ºæ‹¦æˆªå™¨
@Get('debug')
debugEndpoint() {
  return { raw: 'data' };
}
```

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ä¸è¦é‡å¤åŒ…è£…**ï¼šService å±‚ç›´æ¥è¿”å›æ•°æ®å³å¯ï¼Œä¸éœ€è¦æ‰‹åŠ¨åŒ…è£…
2. **Message æå–**ï¼šå¦‚æœè¿”å›å¯¹è±¡åŒ…å« `message` å­—æ®µï¼Œä¼šè¢«è‡ªåŠ¨æå–åˆ°å¤–å±‚
3. **å¼‚å¸¸æŠ›å‡º**ï¼šä½¿ç”¨ NestJS å†…ç½®å¼‚å¸¸ç±»ï¼Œä¸è¦è¿”å›é”™è¯¯å¯¹è±¡
4. **è‡ªå®šä¹‰æ ¼å¼**ï¼šå¦‚æœè¿”å›æ•°æ®å·²åŒ…å« `code` å­—æ®µï¼Œæ‹¦æˆªå™¨ä¼šåŸæ ·è¿”å›

---

## ğŸ“ æœ€ä½³å®è·µ

### âœ… æ¨èå†™æ³•

```typescript
// Controller
@Post()
async create(@Body() dto: CreateUserDto) {
  const user = await this.usersService.create(dto);
  return {
    message: 'åˆ›å»ºæˆåŠŸ',
    user,
  };
}

// Service
async create(dto: CreateUserDto) {
  const user = this.userRepository.create(dto);
  return await this.userRepository.save(user);
}
```

### âŒ ä¸æ¨èå†™æ³•

```typescript
// ä¸è¦åœ¨ Service ä¸­åŒ…è£…å“åº”
async create(dto: CreateUserDto) {
  const user = this.userRepository.create(dto);
  await this.userRepository.save(user);
  
  return {
    code: 200,
    data: user,
    message: 'åˆ›å»ºæˆåŠŸ',
  };
}
```

---

## ğŸ“¦ æ‰©å±•

å¦‚æœéœ€è¦æ·»åŠ æ›´å¤šé€šç”¨åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ `common/` ç›®å½•ä¸‹åˆ›å»ºï¼š

- `decorators/` - è‡ªå®šä¹‰è£…é¥°å™¨
- `guards/` - å…¨å±€å®ˆå«
- `pipes/` - è‡ªå®šä¹‰ç®¡é“
- `utils/` - å·¥å…·å‡½æ•°

---

**æœ€åæ›´æ–°æ—¶é—´ï¼š2024-01-27**